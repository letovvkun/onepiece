<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Админ-панель | One Piece</title>
<link rel="icon" href="data:," />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-1: #1a1a1a; --bg-2: #121212; --glass-bg: rgba(255,255,255,0.03); --card: rgba(255,255,255,0.04);
    --accent-a: #444; --accent-b: #222; --accent-c: #ffb86b; --muted: rgba(234, 234, 234, 0.6);
    --text: #eaeaea; --radius: 16px; --glass-strong: rgba(255,255,255,0.06);
  }
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color:var(--text);
    background: linear-gradient(180deg,var(--bg-1), var(--bg-2));
  }
  .wrap{ max-width:1200px; margin:2rem auto; padding:28px; display:none; }
  .btn{ padding:9px 14px; border-radius:12px; cursor:pointer; font-weight:600; }
  .special-btn{ background: var(--accent-c); color: var(--bg-1); font-weight:800; border:none; }
  .danger-btn{ background: #c73434; color:white; }
  table{ width:100%; border-collapse:collapse; }
  th,td{ padding:12px; border-bottom:1px solid rgba(255,255,255,0.1); }
</style>
</head>
<body>

<!-- Экран входа -->
<div id="login-screen" style="display:flex;align-items:center;justify-content:center;flex-direction:column;min-height:100vh;gap:20px;">
    <h1>Вход в админ-панель</h1>
    <button id="loginBtn" class="btn special-btn" style="font-size:16px;padding:12px 24px;">Войти</button>
</div>

<!-- Основная панель -->
<div class="wrap">
  <header style="display:flex;justify-content:space-between;align-items:center;">
    <h1>Панель управления сериями</h1>
    <div>
      <button id="addEpisodeBtn" class="btn special-btn">Добавить серию</button>
      <button id="logoutBtn" class="btn">Выйти</button>
    </div>
  </header>
  <table id="episodesTable">
    <thead><tr><th>ID</th><th>Название</th><th>Дата</th><th>Действия</th></tr></thead>
    <tbody id="episodesTableBody"></tbody>
  </table>
</div>

<!-- Модальное окно -->
<div id="editModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);align-items:center;justify-content:center;">
  <div style="background:#1a1a1a;padding:20px;border-radius:8px;max-width:600px;width:100%;">
    <h2 id="modalTitle">Добавить серию</h2>
    <form id="episodeForm">
      <input type="hidden" id="editId">
      <label>ID: <input type="number" id="ep-id" required></label><br>
      <label>Дата: <input type="date" id="ep-date" required></label><br>
      <label>Название: <input type="text" id="ep-title" required></label><br>
      <label>Превью: <input type="url" id="ep-thumb"></label><br>
      <label>Dzen iframe: <textarea id="ep-iframe-dzen"></textarea></label><br>
      <label>Mega iframe: <textarea id="ep-iframe-mega"></textarea></label><br>
      <label>Kodik iframe: <textarea id="ep-iframe-kodik"></textarea></label><br>
      <button type="submit" class="btn special-btn">Сохранить</button>
      <button type="button" id="cancelBtn" class="btn">Отмена</button>
    </form>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getFirestore, collection, doc, getDocs, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
  import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBE1AkNd3bPGPr3ZPUbtqNUd2WDCB2SHHw",
    authDomain: "letovshiyori.firebaseapp.com",
    projectId: "letovshiyori",
    storageBucket: "letovshiyori.appspot.com",
    messagingSenderId: "379203362104",
    appId: "1:379203362104:web:20235be9bbbbfdbd6df5cd"
  };

  const ALLOWED_EMAIL = "letovvkun@proton.me";
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const episodesCollection = collection(db, "episodes");

  const loginScreen = document.getElementById("login-screen");
  const mainWrap = document.querySelector(".wrap");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  let episodes = [];

  loginBtn.addEventListener("click", async () => {
    const email = prompt("Введите email:");
    const password = prompt("Введите пароль:");
    if (!email || !password) return;

    try {
      const userCredential = await signInWithEmailAndPassword(auth, email, password);
      if (userCredential.user.email !== ALLOWED_EMAIL) {
        alert("Доступ запрещён");
        await signOut(auth);
      }
    } catch {
      alert("Неверный email или пароль");
    }
  });

  onAuthStateChanged(auth, user => {
    if (user && user.email === ALLOWED_EMAIL) {
      loginScreen.style.display = "none";
      mainWrap.style.display = "block";
      loadEpisodes();
    } else {
      loginScreen.style.display = "flex";
      mainWrap.style.display = "none";
    }
  });

  logoutBtn.addEventListener("click", () => signOut(auth));

  async function loadEpisodes() {
    const tableBody = document.getElementById("episodesTableBody");
    tableBody.innerHTML = "<tr><td colspan='4'>Загрузка...</td></tr>";
    const querySnapshot = await getDocs(episodesCollection);
    episodes = [];
    querySnapshot.forEach(docSnap => episodes.push({ firestoreId: docSnap.id, ...docSnap.data() }));
    renderTable();
  }

  function renderTable() {
    const tableBody = document.getElementById("episodesTableBody");
    tableBody.innerHTML = "";
    episodes.sort((a,b) => b.id - a.id).forEach(ep => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${ep.id}</td>
        <td>${ep.title}</td>
        <td>${ep.date}</td>
        <td>
          <button class="btn edit-btn" data-id="${ep.firestoreId}">Изменить</button>
          <button class="btn danger-btn delete-btn" data-id="${ep.firestoreId}">Удалить</button>
        </td>`;
      tableBody.appendChild(tr);
    });
  }

  document.getElementById("addEpisodeBtn").addEventListener("click", () => openModal());
  document.getElementById("cancelBtn").addEventListener("click", closeModal);
  document.getElementById("episodeForm").addEventListener("submit", saveEpisode);

  function openModal(id = null) {
    const modal = document.getElementById("editModal");
    modal.style.display = "flex";
    if (id) {
      const ep = episodes.find(e => e.firestoreId === id);
      if (ep) {
        document.getElementById("editId").value = id;
        document.getElementById("ep-id").value = ep.id;
        document.getElementById("ep-date").value = ep.date;
        document.getElementById("ep-title").value = ep.title;
        document.getElementById("ep-thumb").value = ep.thumb || "";
        document.getElementById("ep-iframe-dzen").value = ep.players.dzen || "";
        document.getElementById("ep-iframe-mega").value = ep.players.mega || "";
        document.getElementById("ep-iframe-kodik").value = ep.players.kodik || "";
      }
    }
  }

  function closeModal() {
    document.getElementById("editModal").style.display = "none";
  }

  async function saveEpisode(e) {
    e.preventDefault();
    const data = {
      id: parseInt(document.getElementById("ep-id").value, 10),
      title: document.getElementById("ep-title").value,
      date: document.getElementById("ep-date").value,
      thumb: document.getElementById("ep-thumb").value,
      quality: "1080p",
      players: {
        dzen: document.getElementById("ep-iframe-dzen").value,
        mega: document.getElementById("ep-iframe-mega").value,
        kodik: document.getElementById("ep-iframe-kodik").value
      }
    };
    await setDoc(doc(db, "episodes", String(data.id)), data);
    closeModal();
    loadEpisodes();
  }

  document.getElementById("episodesTableBody").addEventListener("click", async e => {
    if (e.target.classList.contains("edit-btn")) {
      openModal(e.target.dataset.id);
    }
    if (e.target.classList.contains("delete-btn")) {
      if (confirm("Удалить эту серию?")) {
        await deleteDoc(doc(db, "episodes", e.target.dataset.id));
        loadEpisodes();
      }
    }
  });
</script>
</body>
</html>
